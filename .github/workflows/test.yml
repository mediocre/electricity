name: Test

on:
  push:
    branches-ignore:
    - 'dependabot**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.14.0]

    env:
      DO_COVERALLS: 22.14.0

    steps:
    - name: Setup Node ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Checkout from Git
      uses: actions/checkout@v2
      with:
        persist-credentials: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install ESLint and Mocha
      run: npm install -g eslint mocha

    - name: Install ESLine dependencies
      run: npm install globals @eslint/js

    - name: Run ESLint
      run: eslint .

    - name: run npm install
      run: npm install

    - name: Run coverage report
      run: |-
        if [ "${{ matrix.node-version }}"x == "${DO_COVERALLS}"x ]
        then
          npm run coveralls
        else
          true
        fi
      env:
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}

    - name: Run without coverage report
      run: |-
        if [ ! "${{ matrix.node-version }}"x == "${DO_COVERALLS}"x ]
        then
          npm test
        else
          true
        fi
      env:
        COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}



    - name: Notify Slack on success
      if: ${{ success() }}
      working-directory: ./${{ env.REPO_NAME }}
      run: |
        GH_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        SLACK_CHANNEL=$(echo "#${{ env.REPO_NAME }}" | sed 's/\./-/g')
        COMMIT_AUTHOR=$(git log -1 --format='%an' ${{ github.sha }})
        COMMIT_MSG=$(git log -1 --pretty=format:%s ${{ github.sha }})
        
        curl -X POST -H 'Content-type: application/json'           --data "{
            "blocks": [
              {
                "text": {
                  "text": ":white_check_mark: Tests passed for ${{ env.REPO_NAME }}",
                  "type": "plain_text"
                },
                "type": "header"
              },
              {
                "text": {
                  "text": "*Author:* ${COMMIT_AUTHOR}
*Branch:* ${{ github.ref_name }}
*Commit:* <${COMMIT_URL}|${SHORT_SHA}>
*Message:* ${COMMIT_MSG}",
                  "type": "mrkdwn"
                },
                "type": "section"
              },
              {
                "elements": [
                  {
                    "text": {
                      "text": "Code Coverage",
                      "type": "plain_text"
                    },
                    "type": "button",
                    "url": "https://coveralls.io/github/mediocre/${REPO_NAME}"
                  },
                  {
                    "text": {
                      "text": "GitHub Action",
                      "type": "plain_text"
                    },
                    "type": "button",
                    "url": "${GH_RUN_URL}"
                  }
                ],
                "type": "actions"
              }
            ],
            "channel": "${SLACK_CHANNEL}",
            "icon_url": "https://mercatalyst.com/apple-touch-icon.png",
            "username": "Mercatalyst"
          }" ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on failure
      if: ${{ failure() }}
      working-directory: ./${{ env.REPO_NAME }}
      run: |
        GH_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        SLACK_CHANNEL=$(echo "#${{ env.REPO_NAME }}" | sed 's/\./-/g')
        COMMIT_AUTHOR=$(git log -1 --format='%an' ${{ github.sha }})
        COMMIT_MSG=$(git log -1 --pretty=format:%s ${{ github.sha }})
        
        curl -X POST -H 'Content-type: application/json'           --data "{
            "blocks": [
              {
                "text": {
                  "text": ":x: Tests failed for ${{ env.REPO_NAME }}",
                  "type": "plain_text"
                },
                "type": "header"
              },
              {
                "text": {
                  "text": "*Author:* ${COMMIT_AUTHOR}
*Branch:* ${{ github.ref_name }}
*Commit:* <${COMMIT_URL}|${SHORT_SHA}>
*Message:* ${COMMIT_MSG}",
                  "type": "mrkdwn"
                },
                "type": "section"
              },
              {
                "elements": [
                  {
                    "text": {
                      "text": "Code Coverage",
                      "type": "plain_text"
                    },
                    "type": "button",
                    "url": "https://coveralls.io/github/mediocre/${REPO_NAME}"
                  },
                  {
                    "text": {
                      "text": "GitHub Action",
                      "type": "plain_text"
                    },
                    "type": "button",
                    "url": "${GH_RUN_URL}"
                  }
                ],
                "type": "actions"
              }
            ],
            "channel": "${SLACK_CHANNEL}",
            "icon_url": "https://mercatalyst.com/apple-touch-icon.png",
            "username": "Mercatalyst"
          }" ${{ secrets.SLACK_WEBHOOK_URL }}
